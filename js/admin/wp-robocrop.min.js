!function(t){var i;i={cropFromFocusPoint:function(t,i){var e=(t.focuspoint.x+1)/2*t.width,h=(-t.focuspoint.y+1)/2*t.height,a=Math.min(t.width/i.min_width,t.height/i.min_height),o=i.min_width*a,n=i.min_height*a,c=Math.min(Math.max(e-o/2,0),t.width-o),r=Math.min(Math.max(h-n/2,0),t.height-n);return{names:i.sizes,x:c/t.width,y:r/t.height,width:o/t.width,height:n/t.height}},relToAbsCoords:function(t,i){var e,h={};for(e in t)switch(e){case"x":case"x1":case"x2":case"width":h[e]=t[e]*i.width;break;case"y":case"y1":case"y2":case"height":h[e]=t[e]*i.height;break;default:h[e]=t[e]}return h},absToRelCoords:function(t,i){var e,h={};for(e in t)switch(e){case"x":case"x1":case"x2":case"width":h[e]=t[e]/i.width;break;case"y":case"y1":case"y2":case"height":h[e]=t[e]/i.height;break;default:h[e]=t[e]}return h},pointToRectCoords:function(t){return{x:t.x1,y:t.y1,width:t.x2-t.x1,height:t.y2-t.y1}},rectToPointCoords:function(t){return{x1:t.x,y1:t.y,x2:t.maxX?t.maxX:t.x+t.width,y2:t.maxY?t.maxY:t.y+t.height}},view:{},controller:{}},t.media.robocrop=i}(wp);
!function(t,e){var i=window.wp_robocrop.image_ratios,o=window.wp_robocrop.image_sizes,s=window.wp_robocrop.l10n;window.wp_robocrop.options;t.media.robocrop.view.Img=t.media.View.extend({className:"attachment-image",tagName:"img",id:"robocrop-image",initialize:function(){_.defaults(this.options,{src:""}),this.$el.attr("src",this.options.src)},getSrc:function(t){return this.$el.attr("src")},setSrc:function(t){return!!t&&this.$el.attr("src",t),this}}),t.media.robocrop.view.RobocropRatioSelect=t.media.View.extend({className:"robocrop-select",template:t.template("robocrop-select"),events:{'click [name="robocrop-select-ratio"]':"selectRatio"},initialize:function(){t.Backbone.View.prototype.initialize.apply(this,arguments),_.defaults({ratios:{},tools:{}},this.options),this.options.l10n=s},render:function(){t.Backbone.View.prototype.render.apply(this,arguments);var i=this;_.each(this.options.tools,function(e,o){i.views.add(new t.media.robocrop.view.RobocropRatioSelectItem({ratiokey:o,sizenames:!1,ratio:o,title:e.title,enabled:!0}))}),_.each(this.options.ratios,function(s,r){var a=[],n='<span class="sizename<%= cancrop ? "" : " disabled" %>"><%= name %> (<%= width %>Ã—<%= height %>)</span>',c=_.template(n);_.each(s.sizes,function(t,s){var r=e.extend(!0,{cancrop:i.model.get("width")>=o[t].width&&i.model.get("height")>=o[t].height},o[t]);r.crop&&a.push(c(r))}),i.views.add(new t.media.robocrop.view.RobocropRatioSelectItem({ratiokey:r,sizenames:a.join(""),ratio:r,title:r+" : 1",enabled:i.model.get("width")>=s.min_width&&i.model.get("height")>=s.min_height}))})},setSelected:function(t){this.$el.find('[name="robocrop-select-ratio"][value="'+t+'"]').prop("checked",!0),this.selectRatio()},getSelected:function(){return this.$el.find('[name="robocrop-select-ratio"]:checked').val()},selectRatio:function(t){this.options.ratios[this.getSelected()]?this.trigger("select-ratio"):this.options.tools[this.getSelected()]&&this.trigger("select-tool"),this.trigger("select")}}),t.media.robocrop.view.RobocropRatioSelectItem=t.media.View.extend({className:"robocrop-select-item",template:t.template("robocrop-select-item"),sizekey:"",sizenames:"",ratio:0,enabled:null,render:function(){t.Backbone.View.prototype.render.apply(this,arguments),this.$el.find('input[type="radio"]').prop("disabled",!this.options.enabled)}}),t.media.robocrop.view.RobocropImage=t.media.View.extend({className:"image-robocrop",template:t.template("robocrop"),image_ratios:i,image_sizes:o,_croppers:null,events:{"click .robocrop-autocrop-current":"autocrop","click .robocrop-autocrop-all":"autocropAll"},initialize:function(e){this._croppers={},this.image=new t.media.robocrop.view.Img({src:this.model.get("url")}),this.controller=e.controller,this.focuspointtool=new t.media.robocrop.view.focuspoint.ImageFocusPointSelect({image:this.image,focuspoint:this.model.get("url")}),this.listenTo(this.focuspointtool,"changed",this.updateFocusPoint),t.media.View.prototype.initialize.apply(this,arguments)},dismiss:function(){var t=this.$areaSelect();t&&t.remove(),this.$el.remove()},createSelect:function(){this.select=new t.media.robocrop.view.RobocropRatioSelect({choices:choices})},hasChanged:function(){this.trigger("changed")},render:function(){var e=this;return t.media.View.prototype.render.apply(this,arguments),this.views.set(".robocrop-content",this.focuspointtool),this.focuspointtool.setFocuspoint(this.model.get("focuspoint")),this.image.$el.imgAreaSelect({parent:this.image.$el.closest(".robocrop-image-box"),instance:!0,handles:!0,keys:!0,persistent:!0,enabled:!0,movable:!0,resizable:!0,imageHeight:this.model.get("height"),imageWidth:this.model.get("width"),onSelectEnd:function(i,o){var s=t.media.robocrop.pointToRectCoords(o);e._setCropSizes(s),e.hasChanged()}}),this.selectRatio=new t.media.robocrop.view.RobocropRatioSelect({tools:{focuspoint:{title:s.SetFocusPoint,trigger:"focuspoint"}},ratios:this.image_ratios,model:this.model}),this.selectRatio.on("select-ratio",this.onselectratio,this).on("select-tool",this.onselecttool,this).on("select",this.updateButtons,this),this.views.set(".select-ratio",this.selectRatio),this.$autoButton=this.$el.find(".robocrop-autocrop-current"),this.$autoAllButton=this.$el.find(".robocrop-autocrop-all"),this},ready:function(){var e,i;return t.media.view.EditImage.prototype.ready.apply(this,arguments),_.isUndefined(this.options.sizeToSelect)||(i=_.find(this.image_ratios,function(t){return t.sizes.indexOf(this.options.sizeToSelect)>-1},this),i&&(e=i.name)),_.isUndefined(e)&&(e="focuspoint"),this.selectRatio.setSelected(e),this},save:function(){var t={attachments:{}},i=this.model.get("id"),o=this.$autoAllButton.add(this.$autoButton).prop("disabled",!0),s=this;return t.attachments[i]={sizes:this.model.get("sizes"),focuspoint:this.model.get("focuspoint")},this.model.saveCompat(t,{}).done(function(t){var i=new Date;_.each(s.model.attributes.sizes,function(t,o){var s='img[src^="'+t.url+'"]',r=function(){e(this).removeAttr("src").attr("src",t.url+"?"+i.getTime())};refresh_mce=function(){e(this).removeAttr("data-mce-src").attr("data-mce-src",t.url+"?"+i.getTime())},"full"!==o&&(e(document).add(e("iframe").contents()).find(s).each(r),e(".mce-edit-area iframe").each(function(){e(this).contents().find(s).each(r).each(refresh_mce)}))},s),o.prop("disabled",!1),s.trigger("saved")}),this},updateButtons:function(){var t=this.selectRatio.getSelected();this.$autoButton.toggleClass("hidden","focuspoint"===t),this.$autoAllButton.toggleClass("hidden","focuspoint"!==t)},onselecttool:function(){var t=this.selectRatio.getSelected();switch(this.$areaSelect().cancelSelection(),t){case"focuspoint":this.focuspointtool.setEnabled(!0)}},onselectratio:function(){this.focuspointtool.setEnabled(!1);var t,e,i,s=this.selectRatio.getSelected(),r=this.model.get("sizes"),a=this,n=this.model.get("width"),c=this.model.get("height");if(this.current_ratio=this.image_ratios[s],i={aspectRatio:this.current_ratio.ratio+":1",minWidth:this.current_ratio.min_width,minHeight:this.current_ratio.min_height},_.each(this.current_ratio.sizes,function(t){!e&&r[t]&&r[t].cropdata&&(e=r[t].cropdata),o[t].width<=n&&o[t].height<=c&&(i.minWidth=Math.max(i.minWidth,o[t].width),i.minHeight=Math.max(i.minHeight,o[t].height))}),e)t={},_.extend(t,e);else{var h=Math.min(this.model.get("width")/this.current_ratio.ratio,this.model.get("height"));t={x:0,y:0,width:h*this.current_ratio.ratio,height:h},t.x=(this.model.get("width")-t.width)/2,t.y=(this.model.get("height")-t.height)/2}return this.$areaSelect().setOptions(i),this.image.$el.get(0).complete?this.selectCrop(t):this.image.$el.on("load",function(){a.selectCrop(t)}),this},autocrop:function(e){var i,o={width:this.model.get("width"),height:this.model.get("height"),focuspoint:this.model.get("focuspoint")};return i=t.media.robocrop.cropFromFocusPoint(o,this.current_ratio),i=t.media.robocrop.relToAbsCoords(i,o),this._setCropSizes(i),this.selectCrop(i),this},autocropAll:function(e){var i=this,o={width:this.model.get("width"),height:this.model.get("height"),focuspoint:this.model.get("focuspoint")};return _.each(this.image_ratios,function(e){var s;s=t.media.robocrop.cropFromFocusPoint(o,e),s=t.media.robocrop.relToAbsCoords(s,o),i._setCropSizes(s,e)}),this},selectCrop:function(e){var i=(this._image_scale_factor(),t.media.robocrop.rectToPointCoords(e)),o=this.$areaSelect();return o.setSelection(i.x1,i.y1,i.x2,i.y2,!1),o.setOptions({show:!0}),o.update(),this},$areaSelect:function(){return this.image.$el.data("imgAreaSelect")},_image_scale_factor:function(){var t=this.image.$el.closest(".robocrop-image-box"),e=Math.min(this.model.get("width"),t.width()),i=Math.min(this.model.get("height"),t.height());return Math.min(e/this.model.get("width"),i/this.model.get("height"))},updateFocusPoint:function(){this.model.set("focuspoint",this.focuspointtool.getFocuspoint())},_setCropSizes:function(t,e){var i=this.model.get("sizes");e=e||this.current_ratio,_.each(e.sizes,function(e){!i[e]&&(i[e]={}),i[e].cropdata=t}),this.model.set("sizes",i)},_getRelativeCoords:function(t){var e=this.model.get("width"),i=this.model.get("height");for(var o in t)if("number"==typeof t[o])switch(o){case"x":case"x1":case"x2":case"width":case"minX":case"maxX":t[o]/=e;break;default:t[o]/=i}},_getAbsoluteCoords:function(t){var e=this.model.get("width"),i=this.model.get("height");for(var o in t)if("number"==typeof t[o])switch(o){case"x":case"x1":case"x2":case"width":case"minX":case"maxX":t[o]*=e;break;default:t[o]*=i}}}),t.media.robocrop.view.Frame=t.media.view.MediaFrame.extend({template:t.template("robocrop-modal"),regions:["title","content","instructions","buttons"]}),t.media.robocrop.view.Frame.Crop=t.media.robocrop.view.Frame.extend({events:{"click .robocrop-save":"save","click .robocrop-cancel":"close"},save:function(){this.$(".robocrop-save, .robocrop-cancel").prop("disabled",!0),this._content.save()},initialize:function(e){t.media.robocrop.view.Frame.prototype.initialize.apply(this,arguments),this.createTitle(),this.createContent(),this.createButtons(),this.on("close",this.dismiss,this),this.listenTo(this._content,"saved",this.modelSync)},modelSync:function(){this.$(".robocrop-save, .robocrop-cancel").prop("disabled",!1)},dismiss:function(){this._content.dismiss()},createTitle:function(){this._title=new t.media.View({tagName:"h1"}),this._title.$el.text(s.AttachmentDetails),this.title.set([this._title])},createContent:function(){var e=_.extend({controller:this.controller,model:this.model},this.options);this._content=new t.media.robocrop.view.RobocropImage(e),this.content.set([this._content])},createButtons:function(){this.buttons.set([new t.media.view.Button({text:s.Close,className:"button-secondary robocrop-cancel"}),new t.media.view.Button({text:s.SaveChanges,className:"button-primary robocrop-save"})])}})}(wp,jQuery);
!function(t,i){var e=(window.wp_robocrop.image_ratios,window.wp_robocrop.image_sizes,window.wp_robocrop.l10n),o=t.media.View;t.media.view.MediaFrame;t.media.robocrop.view.focuspoint={},t.media.robocrop.view.focuspoint.FocusPoint=o.extend({className:"tool-focuspoint",template:t.template("focuspoint"),initialize:function(){var t=this;_.defaults(this.options,{focuspoint:{x:0,y:0},enabled:!1}),this.$el.on("click",function(i){t.clickFocuspoint(i)})},setEnabled:function(t){var i=this.options.enabled;return this.options.enabled=t,i},clickFocuspoint:function(t){this.options.enabled&&this.setFocuspoint({x:2*t.offsetX/i(t.target).width()-1,y:-2*t.offsetY/i(t.target).height()+1})},getFocuspoint:function(){return this.focuspoint},setFocuspoint:function(t){return this.focuspoint=t,this.$el.find(".focuspoint").css({left:50*(t.x+1)+"%",bottom:50*(t.y+1)+"%"}),this.options.enabled&&this.trigger("change:focuspoint",this.focuspoint),this}}),t.media.robocrop.view.focuspoint.ImageFocusPointSelect=o.extend({className:"robocrop-image-box",initialize:function(){_.defaults(this.options,{controller:this,focuspoint:{x:0,y:0},src:!1,image:!1,enabled:!1});this.options.image!==!1&&this.options.image.constructor.prototype==t.media.robocrop.view.Img.prototype?this.image=this.options.image:this.options.src!==!1?this.image=new t.media.robocrop.view.Img({src:this.options.src}):this.image=new t.media.robocrop.view.Img({src:""},this.options.image),this.focuspoint=new t.media.robocrop.view.focuspoint.FocusPoint({controller:this.controller,focuspoint:this.options.focuspoint,enabled:this.options.enabled}),this.listenTo(this.focuspoint,"change:focuspoint",this.valueChanged)},setEnabled:function(t){return this.focuspoint.setEnabled(t)},render:function(){this.views.set([this.image,this.focuspoint])},getFocuspoint:function(){return this.focuspoint.getFocuspoint()},setFocuspoint:function(t){return this.focuspoint&&this.focuspoint.setFocuspoint(t),this},getImageWidth:function(){return this.image.$el.get(0).naturalWidth},getImageHeight:function(){return this.image.$el.get(0).naturalHeight},setSrc:function(t){return this.image.$el.attr("src",t),this},valueChanged:function(){this.trigger("changed")}}),t.media.robocrop.view.Frame.Focuspoint=t.media.robocrop.view.Frame.extend({className:"ask-focuspoint media-frame",events:{"click .reset":"reset","click .proceed":"proceed","click .cancel-upload":"cancelUpload"},initialize:function(){_.defaults(this.options,{uploader:!1,title:e.SetFocusPoint,modal:!!this.options&&this.options.modal,src:""}),t.media.robocrop.view.Frame.prototype.initialize.apply(this,arguments),this.modal&&this.modal.on("escape",this.cancelUpload,this),this.createTitle(),this.createContent(),this.createInstructions(),this.createButtons()},createTitle:function(){this._title=new t.media.View({tagName:"h1"}),this._title.$el.text(this.options.title),this.title.set([this._title])},createContent:function(){this._content=new t.media.robocrop.view.focuspoint.ImageFocusPointSelect({src:"",focuspoint:{x:0,y:0},controller:this,enabled:!0}),this.content.set([this._content])},createInstructions:function(){this.instructions.set([new t.media.View({el:i('<div class="instructions">'+e.FocusPointInstructions+"</div>")[0],priority:-40})])},createButtons:function(){this.buttons.set([new t.media.view.Button({text:e.CancelUpload,className:"cancel-upload"}),new t.media.view.Button({text:e.Reset,className:"reset"}),new t.media.view.Button({text:e.Okay,className:"button-primary proceed"})])},setSrc:function(t){this._content.setSrc(t)},setFile:function(t){var i=this,e=new FileReader;e.onload=function(t){i.setSrc(e.result)},e.readAsDataURL(t)},setFocuspoint:function(t){this._content.setFocuspoint(t)},getFocuspoint:function(){return this._content.getFocuspoint()},getImageWidth:function(){return this._content.getImageWidth()},getImageHeight:function(){return this._content.getImageHeight()},reset:function(t){this.setFocuspoint({x:0,y:0})},proceed:function(t){this.trigger("proceed")},cancelUpload:function(t){this.trigger("cancel-upload"),this.close()}})}(wp,jQuery);
!function(e,t){var o=(window.wp_robocrop.image_ratios,window.wp_robocrop.image_sizes,window.wp_robocrop.l10n),n=(window.wp_robocrop.options,'<button type="button" class="button robocrop-open">'+o.EditImageSizes+"</button>"),r='<button type="button" class="button-link robocrop-open">'+o.EditImageSizes+"</button>",i={createStates:function(){this._parentCreateStates.apply(this,arguments),this.states.add(new e.media.robocrop.controller.RobocropImage({model:this.model,selection:this.options.selection}))}};_.extend(e.media.view.ImageDetails.prototype,{_parentPostRender:e.media.view.ImageDetails.prototype.postRender,postRender:function(){this._parentPostRender.apply(this,arguments),this.$el.find(".actions").append(n)},robocropOpen:function(t){console.log();var o=this.model.get("size"),n=new e.media.robocrop.view.Frame.Crop({controller:this.controller,model:this.controller.image.attachment,sizeToSelect:o});n.open()}}),e.media.view.ImageDetails.prototype.events["click .robocrop-open"]="robocropOpen",_.extend(e.media.view.Attachment.Details.prototype,{_parentRender:e.media.view.Attachment.Details.prototype.render,render:function(){this._parentRender.apply(this,arguments),"image"===this.model.get("type")&&(this.$(".attachment-actions").append(n),t(r).insertAfter(this.$el.find("a.edit-attachment")))},robocropOpen:function(t){var o=new e.media.robocrop.view.Frame.Crop({controller:this.controller,model:this.model});o.open()},_parentCreateStates:e.media.view.Attachment.Details.prototype.createStates},i),e.media.view.Attachment.Details.prototype.events["click .robocrop-open"]="robocropOpen"}(wp,jQuery);
!function(e){var o=window.wp_robocrop.image_ratios,i=(window.wp_robocrop.image_sizes,window.wp_robocrop.options),t={};i.ask_for_focuspoint&&_.extend(wp.media.view.UploaderWindow.prototype,{_parentReady:wp.media.view.UploaderWindow.prototype.ready,didReady:!1,ready:function(){function i(o){var n;r&&r.close().dispose(),p.length?(n=p.shift(),r=new wp.media.robocrop.view.Frame.Focuspoint({controller:e(this)}),r.on("proceed",function(){t[n.file.name]={focuspoint:r.getFocuspoint(),width:r.getImageWidth(),height:r.getImageHeight()},i(o)}).on("cancel-upload",function(){n.file.attachment.destroy()}),r.setFocuspoint({x:0,y:0}),r.setFile(n.blob),r.open()):o.start()}function n(e,o){p.push(e)}function a(e){var o={file:e,blob:e.getNative()};return o.blob||(o.blob=e.getSource()),o}var r,p=[];return this.didReady?this._parentReady.apply(this,arguments):(this.didReady=!0,ret=this._parentReady.apply(this,arguments),this.uploader.uploader.bind("FilesAdded",function(e,o){for(var t,r=0;r<o.length;r++)"image/png"!=o[r].type&&"image/jpeg"!=o[r].type||(t=a(o[r]),t.blob instanceof Blob&&n(t,e));p.length&&(e.stop(),e.refresh(),i(e),console.log("askfocus"))}),this.uploader.uploader.bind("BeforeUpload",function(e,i){var n,a;if(t[i.name]){imageinfo=t[i.name],a={};for(n in o)a[o[n].name]=wp.media.robocrop.cropFromFocusPoint(imageinfo,o[n]);e.settings.multipart_params.focuspoint=JSON.stringify(imageinfo.focuspoint),e.settings.multipart_params.cropdata=JSON.stringify(a),delete t[i.name]}}),ret)}})}(jQuery);
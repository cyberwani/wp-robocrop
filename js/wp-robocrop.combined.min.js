/*
 (c) 2016 by Joern Lund
 @license GPL3
*/
(function(e){e.media.robocrop={cropFromFocusPoint:function(a,d){var b=Math.min(a.width/d.min_width,a.height/d.min_height),c=d.min_width*b,b=d.min_height*b;return{names:d.sizes,x:Math.min(Math.max((a.focuspoint.x+1)/2*a.width-c/2,0),a.width-c)/a.width,y:Math.min(Math.max((-a.focuspoint.y+1)/2*a.height-b/2,0),a.height-b)/a.height,width:c/a.width,height:b/a.height}},relToAbsCoords:function(a,d){var b,c={};for(b in a)switch(b){case "x":case "x1":case "x2":case "width":c[b]=a[b]*d.width;break;case "y":case "y1":case "y2":case "height":c[b]=
a[b]*d.height;break;default:c[b]=a[b]}return c},absToRelCoords:function(a,d){var b,c={};for(b in a)switch(b){case "x":case "x1":case "x2":case "width":c[b]=a[b]/d.width;break;case "y":case "y1":case "y2":case "height":c[b]=a[b]/d.height;break;default:c[b]=a[b]}return c},pointToRectCoords:function(a){return{x:a.x1,y:a.y1,width:a.x2-a.x1,height:a.y2-a.y1}},rectToPointCoords:function(a){return{x1:a.x,y1:a.y,x2:a.maxX?a.maxX:a.x+a.width,y2:a.maxY?a.maxY:a.y+a.height}},view:{},controller:{}}})(wp);
(function(b,d){var c=window.wp_robocrop.l10n,f=b.media.View,e=b.media.view.MediaFrame;b.media.robocrop.view.focuspoint={};b.media.robocrop.view.focuspoint.FocusPoint=f.extend({className:"tool-focuspoint",template:b.template("focuspoint"),initialize:function(){var a=this;_.defaults(this.options,{focuspoint:{x:0,y:0},enabled:!1});this.$el.on("click",function(b){a.clickFocuspoint(b)})},setEnabled:function(a){var b=this.options.enabled;this.options.enabled=a;return b},clickFocuspoint:function(a){this.options.enabled&&
this.setFocuspoint({x:2*a.offsetX/d(a.target).width()-1,y:-2*a.offsetY/d(a.target).height()+1})},getFocuspoint:function(){return this.focuspoint},setFocuspoint:function(a){this.focuspoint=a;this.$el.find(".focuspoint").css({left:50*(a.x+1)+"%",bottom:50*(a.y+1)+"%"});this.options.enabled&&this.trigger("change:focuspoint",this.focuspoint);return this}});b.media.robocrop.view.focuspoint.ImageFocusPointSelect=f.extend({className:"robocrop-image-box",initialize:function(){_.defaults(this.options,{controller:this,
focuspoint:{x:0,y:0},src:!1,image:!1,enabled:!1});this.image=!1!==this.options.image&&this.options.image.constructor.prototype==b.media.robocrop.view.Img.prototype?this.options.image:!1!==this.options.src?new b.media.robocrop.view.Img({src:this.options.src}):new b.media.robocrop.view.Img({src:""},this.options.image);this.focuspoint=new b.media.robocrop.view.focuspoint.FocusPoint({controller:this.controller,focuspoint:this.options.focuspoint,enabled:this.options.enabled});this.listenTo(this.focuspoint,
"change:focuspoint",this.valueChanged)},setEnabled:function(a){return this.focuspoint.setEnabled(a)},render:function(){this.views.set([this.image,this.focuspoint])},getFocuspoint:function(){return this.focuspoint.getFocuspoint()},setFocuspoint:function(a){this.focuspoint&&this.focuspoint.setFocuspoint(a);return this},getImageWidth:function(){return this.image.$el.get(0).naturalWidth},getImageHeight:function(){return this.image.$el.get(0).naturalHeight},setSrc:function(a){this.image.$el.attr("src",
a);return this},valueChanged:function(){this.trigger("changed")}});b.media.robocrop.view.focuspoint.AskFocuspoint=e.extend({className:"ask-focuspoint media-frame",template:b.template("ask-focuspoint"),regions:["title","imagewrap","instructions","buttons"],events:{"click .reset":"reset","click .proceed":"proceed","click .cancel-upload":"cancelUpload"},initialize:function(){_.defaults(this.options,{uploader:!1,title:c.SetFocusPoint,modal:this.options?this.options.modal:!1,src:""});e.prototype.initialize.apply(this,
arguments);if(this.modal)this.modal.on("escape",this.cancelUpload,this);this.createTitle();this.createContent();this.createInstructions();this.createButtons()},render:function(){this.$el.addClass("hide-menu").addClass("hide-router");e.prototype.render.apply(this,arguments)},createTitle:function(){this._title=new b.media.View({tagName:"h1"});this._title.$el.text(this.options.title);this.title.set([this._title])},createContent:function(){this._content=new b.media.robocrop.view.focuspoint.ImageFocusPointSelect({src:"",
focuspoint:{x:0,y:0},controller:this,enabled:!0});this.imagewrap.set([this._content])},createInstructions:function(){this.instructions.set([new b.media.View({el:d('<div class="instructions">'+c.FocusPointInstructions+"</div>")[0],priority:-40})])},createButtons:function(){this.buttons.set([new b.media.view.Button({text:c.CancelUpload,className:"cancel-upload"}),new b.media.view.Button({text:c.Reset,className:"reset"}),new b.media.view.Button({text:c.Okay,className:"button-primary proceed"})])},setSrc:function(a){this._content.setSrc(a)},
setFile:function(a){var b=this,c=new FileReader;c.onload=function(a){b.setSrc(c.result)};c.readAsDataURL(a)},setFocuspoint:function(a){this._content.setFocuspoint(a)},getFocuspoint:function(){return this._content.getFocuspoint()},getImageWidth:function(){return this._content.getImageWidth()},getImageHeight:function(){return this._content.getImageHeight()},reset:function(a){this.setFocuspoint({x:0,y:0})},proceed:function(a){this.trigger("proceed")},cancelUpload:function(a){this.trigger("cancel-upload");
this.close()}})})(wp,jQuery);
(function(b,h){var u=window.wp_robocrop.image_ratios,g=window.wp_robocrop.image_sizes,f=window.wp_robocrop.l10n,t='<button type="button" class="button robocrop-attachment">'+f.CropImage+"</button>",v='<button type="button" class="button-link robocrop-attachment">'+f.CropImage+"</button>",k=null,n=null,m=null,p=null,q={createStates:function(){this._parentCreateStates.apply(this,arguments);this.states.add(new b.media.robocrop.controller.RobocropImage({model:this.model,selection:this.options.selection}))}},
r={bindHandlers:function(){this._parentBindHandlers.apply(this,arguments);this.on("content:create:robocrop-image",this.robocropImageMode,this);this.on("content:render:robocrop-image",this.robocropImageModeRender,this)},robocropImageMode:function(a){var e=new b.media.robocrop.controller.RobocropImage({model:n,frame:this,content:this.content});e._toolbar=function(){};e._router=function(){};e._menu=function(){};a.view=new b.media.robocrop.view.RobocropImage({model:n,frame:this,controller:this.controller})},
robocropImageModeRenderer:function(a){a.on("ready",a.loadEditor)}};_.extend(b.media.view.MediaFrame.EditAttachments.prototype,{_parentBindHandlers:b.media.view.MediaFrame.EditAttachments.prototype.bindHandlers},r);_.extend(b.media.view.MediaFrame.Post.prototype,{_parentBindHandlers:b.media.view.MediaFrame.Post.prototype.bindHandlers,_parentCreateStates:b.media.view.MediaFrame.Post.prototype.createStates},r,q);_.extend(b.media.view.ImageDetails.prototype,{_parentPostRender:b.media.view.ImageDetails.prototype.postRender,
postRender:function(){this._parentPostRender.apply(this,arguments);this.$el.find(".actions").append(t)},robocropAttachment:function(a){var b=this.controller.states.get("robocrop-image");n=this.controller.image.attachment;k=null;p=this.controller;m=this.controller.state();b&&(a.preventDefault(),this.controller.setState("robocrop-image"))}});b.media.view.ImageDetails.prototype.events["click .robocrop-attachment"]="robocropAttachment";_.extend(b.media.view.MediaFrame.ImageDetails.prototype,{_parentBindHandlers:b.media.view.MediaFrame.ImageDetails.prototype.bindHandlers,
_parentCreateStates:b.media.view.MediaFrame.ImageDetails.prototype.createStates},r,q);_.extend(b.media.view.Attachment.Details.prototype,{_parentRender:b.media.view.Attachment.Details.prototype.render,render:function(){this._parentRender.apply(this,arguments);this.$(".attachment-actions").append(t);h(v).insertAfter(this.$el.find("a.edit-attachment"))},robocropAttachment:function(a){var b=this.controller.states.get("robocrop-image");n=this.model;p=this.controller;b?(k=null,m=this.controller.state(),
a.preventDefault(),this.controller.setState("robocrop-image")):(k=this.controller.content.mode(),m=null,this.controller.content.mode("robocrop-image"))},_parentCreateStates:b.media.view.Attachment.Details.prototype.createStates},q);b.media.view.Attachment.Details.prototype.events["click .robocrop-attachment"]="robocropAttachment";b.media.robocrop.view.Img=b.media.View.extend({className:"attachment-image",tagName:"img",id:"robocrop-image",initialize:function(){_.defaults(this.options,{src:""});this.$el.attr("src",
this.options.src)},getSrc:function(a){return this.$el.attr("src")},setSrc:function(a){a&&this.$el.attr("src",a);return this}});b.media.robocrop.view.RobocropRatioSelect=b.media.View.extend({className:"robocrop-select",template:b.template("robocrop-select"),events:{'click [name="robocrop-select-ratio"]':"selectRatio"},initialize:function(){b.Backbone.View.prototype.initialize.apply(this,arguments);_.defaults({ratios:{},tools:{}},this.options);this.options.l10n=f},render:function(){b.Backbone.View.prototype.render.apply(this,
arguments);var a=this;_.each(this.options.tools,function(e,c){a.views.add(new b.media.robocrop.view.RobocropRatioSelectItem({ratiokey:c,sizenames:!1,ratio:c,title:e.title,enabled:!0}))});_.each(this.options.ratios,function(e,c){var d=[],f=_.template('<span class="sizename<%= cancrop ? "" : " disabled" %>"><%= name %> (<%= width %>\u00d7<%= height %>)</span>');_.each(e.sizes,function(b,e){var c=h.extend(!0,{cancrop:a.model.get("width")>=g[b].width&&a.model.get("height")>=g[b].height},g[b]);c.crop&&
d.push(f(c))});a.views.add(new b.media.robocrop.view.RobocropRatioSelectItem({ratiokey:c,sizenames:d.join(""),ratio:c,title:c+" : 1",enabled:a.model.get("width")>=e.min_width&&a.model.get("height")>=e.min_height}))})},setSelected:function(a){this.$el.find('[name="robocrop-select-ratio"][value="'+a+'"]').prop("checked",!0);this.selectRatio()},getSelected:function(){return this.$el.find('[name="robocrop-select-ratio"]:checked').val()},selectRatio:function(a){this.options.ratios[this.getSelected()]?
this.trigger("select-ratio"):this.options.tools[this.getSelected()]&&this.trigger("select-tool")}});b.media.robocrop.view.RobocropRatioSelectItem=b.media.View.extend({className:"robocrop-select-item",template:b.template("robocrop-select-item"),sizekey:"",sizenames:"",ratio:0,enabled:null,render:function(){b.Backbone.View.prototype.render.apply(this,arguments);this.$el.find('input[type="radio"]').prop("disabled",!this.options.enabled)}});b.media.robocrop.view.RobocropImage=b.media.View.extend({className:"image-robocrop",
template:b.template("robocrop"),image_ratios:u,image_sizes:g,_croppers:null,events:{"click .robocrop-autocrop":"autocrop","click .robocrop-cancel":"cancel","click .robocrop-save":"save"},initialize:function(a){this._croppers={};this.sizeToSelect=a.frame&&a.frame.image?a.frame.image.attributes.size:!1;this.image=new b.media.robocrop.view.Img({src:this.model.get("url")});this.controller=a.controller;this.focuspointtool=new b.media.robocrop.view.focuspoint.ImageFocusPointSelect({image:this.image,focuspoint:this.model.get("url")});
this.listenTo(this.focuspointtool,"changed",this.updateFocusPoint);b.media.View.prototype.initialize.apply(this,arguments)},dispose:function(){var a=this.$areaSelect();a&&a.remove();b.media.view.EditImage.prototype.dispose.apply(this,arguments)},createSelect:function(){this.select=new b.media.robocrop.view.RobocropRatioSelect({choices:choices})},render:function(){var a=this;b.media.View.prototype.render.apply(this,arguments);this.views.set(".robocrop-image-box",this.focuspointtool);this.focuspointtool.setFocuspoint(this.model.get("focuspoint"));
this.image.$el.imgAreaSelect({parent:this.image.$el.closest(".robocrop-image-box"),instance:!0,handles:!0,keys:!0,persistent:!0,enabled:!0,movable:!0,resizable:!0,imageHeight:this.model.get("height"),imageWidth:this.model.get("width"),onSelectEnd:function(e,c){var d=b.media.robocrop.pointToRectCoords(c);a._setCropSizes(d);a.$saveButton.prop("disabled",!1)}});this.selectRatio=new b.media.robocrop.view.RobocropRatioSelect({tools:{focuspoint:{title:f.SetFocusPoint,trigger:"focuspoint"}},ratios:this.image_ratios,
model:this.model});this.selectRatio.on("select-ratio",this.onselectratio,this).on("select-tool",this.onselecttool,this);this.views.set(".select-ratio",this.selectRatio);this.$saveButton=this.$el.find(".robocrop-save");this.$cancelButton=this.$el.find(".robocrop-cancel");this.$autoButton=this.$el.find(".robocrop-autocrop");return this},ready:function(){var a,e;b.media.view.EditImage.prototype.ready.apply(this,arguments);this.sizeToSelect&&(e=_.find(this.image_ratios,function(a){return-1<a.sizes.indexOf(this.sizeToSelect)},
this))&&(a=e.name);a||(a="focuspoint");this.selectRatio.setSelected("focuspoint");return this},save:function(){var a={attachments:{}},b=this.model.get("id"),c=this.$saveButton.add(this.$cancelButton).add(this.$autoButton).prop("disabled",!0),d=this;a.attachments[b]={sizes:this.model.get("sizes"),focuspoint:this.model.get("focuspoint")};this.model.saveCompat(a,{}).done(function(a){var b=new Date;_.each(d.model.attributes.sizes,function(a,e){"full"!==e&&h(document).add(h("iframe").contents()).find('img[src^="'+
a.url+'"]').each(function(){h(this).attr("src",a.url+"?"+b.getTime())})},d);c.prop("disabled",!1)});return this},cancel:function(){k?p.content.mode(k):m&&p.setState(m);return this},onselecttool:function(){var a=this.selectRatio.getSelected();this.$areaSelect().cancelSelection();this.$autoButton.prop("disabled",!0);switch(a){case "focuspoint":this.focuspointtool.setEnabled(!0)}},onselectratio:function(){this.focuspointtool.setEnabled(!1);this.$autoButton.prop("disabled",!1);var a=this.selectRatio.getSelected(),
b=this.model.get("sizes"),c,d,f=this,l,h=this.model.get("width"),k=this.model.get("height");this.current_ratio=this.image_ratios[a];l={aspectRatio:this.current_ratio.ratio+":1",minWidth:this.current_ratio.min_width,minHeight:this.current_ratio.min_height};_.each(this.current_ratio.sizes,function(a){!d&&b[a]&&b[a].cropdata&&(d=b[a].cropdata);g[a].width<=h&&g[a].height<=k&&(l.minWidth=Math.max(l.minWidth,g[a].width),l.minHeight=Math.max(l.minHeight,g[a].height))});d?(c={},_.extend(c,d)):(a=Math.min(this.model.get("width")/
this.current_ratio.ratio,this.model.get("height")),c={x:0,y:0,width:a*this.current_ratio.ratio,height:a},c.x=(this.model.get("width")-c.width)/2,c.y=(this.model.get("height")-c.height)/2);this.$areaSelect().setOptions(l);if(this.image.$el.get(0).complete)this.selectCrop(c);else this.image.$el.on("load",function(){f.selectCrop(c)});return this},autocrop:function(a){var e={width:this.model.get("width"),height:this.model.get("height"),focuspoint:this.model.get("focuspoint")};a=b.media.robocrop.cropFromFocusPoint(e,
this.current_ratio);a=b.media.robocrop.relToAbsCoords(a,e);this._setCropSizes(a);this.selectCrop(a);this.$saveButton.prop("disabled",!1);return this},selectCrop:function(a){this._image_scale_factor();a=b.media.robocrop.rectToPointCoords(a);var e=this.$areaSelect();e.setSelection(a.x1,a.y1,a.x2,a.y2,!1);e.setOptions({show:!0});e.update();return this},$areaSelect:function(){return this.image.$el.data("imgAreaSelect")},_image_scale_factor:function(){var a=this.image.$el.closest(".robocrop-image-box"),
b=Math.min(this.model.get("width"),a.width()),a=Math.min(this.model.get("height"),a.height());return Math.min(b/this.model.get("width"),a/this.model.get("height"))},updateFocusPoint:function(){this.model.set("focuspoint",this.focuspointtool.getFocuspoint());this.$saveButton.prop("disabled",!1)},_setCropSizes:function(a){var b=this.model.get("sizes");_.each(this.current_ratio.sizes,function(c){!b[c]&&(b[c]={});b[c].cropdata=a});this.model.set("sizes",b)},_getRelativeCoords:function(a){var b=this.model.get("width"),
c=this.model.get("height"),d;for(d in a)if("number"===typeof a[d])switch(d){case "x":case "x1":case "x2":case "width":case "minX":case "maxX":a[d]/=b;break;default:a[d]/=c}},_getAbsoluteCoords:function(a){var b=this.model.get("width"),c=this.model.get("height"),d;for(d in a)if("number"===typeof a[d])switch(d){case "x":case "x1":case "x2":case "width":case "minX":case "maxX":a[d]*=b;break;default:a[d]*=c}}});b.media.robocrop.controller.RobocropImage=b.media.controller.State.extend({defaults:{id:"robocrop-image",
title:f.RobocropImage,menu:!1,toolbar:"robocrop-image",content:"robocrop-image",url:""},activate:function(){this.listenTo(this.frame,"toolbar:render:robocrop-image",this.toolbar)},deactivate:function(){this.stopListening(this.frame)}})})(wp,jQuery);
(function(){var l=window.wp_robocrop.image_ratios,d={};window.wp_robocrop.options.ask_for_focuspoint&&_.extend(wp.media.view.UploaderWindow.prototype,{_parentReady:wp.media.view.UploaderWindow.prototype.ready,didReady:!1,ready:function(){function m(n){var b;a&&a.close().dispose();k.length?(b=k.shift(),a=new wp.media.robocrop.view.focuspoint.AskFocuspoint({modal:!0}),a.on("proceed",function(){d[b.file.name]={focuspoint:a.getFocuspoint(),width:a.getImageWidth(),height:a.getImageHeight()};m(n)}).on("cancel-upload",
function(){b.file.attachment.destroy()}),a.setFocuspoint({x:0,y:0}),b.dataUrl?a.setSrc(b.dataUrl):a.setFile(b.blob),a.open()):n.start()}var k=[],a;if(this.didReady)return this._parentReady.apply(this,arguments);this.didReady=!0;ret=this._parentReady.apply(this,arguments);this.uploader.uploader.bind("FilesAdded",function(a,b){a.stop();a.refresh();for(var c=0;c<b.length;c++)if("image/png"==b[c].type||"image/jpeg"==b[c].type){var e=b[c],f={file:e,blob:e.getNative(),dataUrl:!1},g=void 0,d=void 0,h=void 0;
f.blob||(f.blob=e.getSource());if(f.blob.getSource&&(g=f.blob.getSource(),"string"===typeof g)){f.dataUrl="data:"+e.type+";base64,"+btoa(g);d=new Uint8Array(g.length);for(h=0;h<g.length;h++)d[h]=g.charCodeAt(h);f.blob=new Blob(d,{type:f.file.type})}(fileData=f)&&k.push(fileData)}k.length?m(a):a.start()});this.uploader.uploader.bind("BeforeUpload",function(a,b){var c,e;if(d[b.name]){imageinfo=d[b.name];e={};for(c in l)e[l[c].name]=wp.media.robocrop.cropFromFocusPoint(imageinfo,l[c]);a.settings.multipart_params.focuspoint=
JSON.stringify(imageinfo.focuspoint);a.settings.multipart_params.cropdata=JSON.stringify(e);delete d[b.name]}});return ret}})})();

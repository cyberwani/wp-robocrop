/*
 (c) 2016 by Joern Lund
 @license GPL3
*/
(function(e){e.media.robocrop={cropFromFocusPoint:function(a,d){var b=Math.min(a.width/d.min_width,a.height/d.min_height),c=d.min_width*b,b=d.min_height*b;return{names:d.sizes,x:Math.min(Math.max((a.focuspoint.x+1)/2*a.width-c/2,0),a.width-c)/a.width,y:Math.min(Math.max((-a.focuspoint.y+1)/2*a.height-b/2,0),a.height-b)/a.height,width:c/a.width,height:b/a.height}},relToAbsCoords:function(a,d){var b,c={};for(b in a)switch(console.log(b),b){case "x":case "x1":case "x2":case "width":c[b]=a[b]*d.width;
break;case "y":case "y1":case "y2":case "height":c[b]=a[b]*d.height;break;default:c[b]=a[b]}return c},absToRelCoords:function(a,d){var b,c={};for(b in a)switch(b){case "x":case "x1":case "x2":case "width":c[b]=a[b]/d.width;break;case "y":case "y1":case "y2":case "height":c[b]=a[b]/d.height;break;default:c[b]=a[b]}return c},pointToRectCoords:function(a){return{x:a.x1,y:a.y1,width:a.x2-a.x1,height:a.y2-a.y1}},rectToPointCoords:function(a){return{x1:a.x,y1:a.y,x2:a.maxX?a.maxX:a.x+a.width,y2:a.maxY?
a.maxY:a.y+a.height}},view:{},controller:{}}})(wp);
(function(b,d){var c=window.wp_robocrop.l10n,f=b.media.View,e=b.media.view.MediaFrame;b.media.robocrop.view.focuspoint={};b.media.robocrop.view.focuspoint.FocusPoint=f.extend({className:"tool-focuspoint",template:b.template("focuspoint"),initialize:function(){var a=this;_.defaults(this.options,{focuspoint:{x:0,y:0},enabled:!1});this.$el.on("click",function(b){a.clickFocuspoint(b)})},setEnabled:function(a){var b=this.options.enabled;this.options.enabled=a;return b},clickFocuspoint:function(a){this.options.enabled&&
this.setFocuspoint({x:2*a.offsetX/d(a.target).width()-1,y:-2*a.offsetY/d(a.target).height()+1})},getFocuspoint:function(){return this.focuspoint},setFocuspoint:function(a){this.focuspoint=a;this.$el.find(".focuspoint").css({left:50*(a.x+1)+"%",bottom:50*(a.y+1)+"%"});this.options.enabled&&this.trigger("change:focuspoint",this.focuspoint);return this}});b.media.robocrop.view.focuspoint.ImageFocusPointSelect=f.extend({className:"robocrop-image-box",initialize:function(){_.defaults(this.options,{controller:this,
focuspoint:{x:0,y:0},src:!1,image:!1,enabled:!1});this.image=!1!==this.options.image&&this.options.image.constructor.prototype==b.media.robocrop.view.Img.prototype?this.options.image:!1!==this.options.src?new b.media.robocrop.view.Img({src:this.options.src}):new b.media.robocrop.view.Img({src:""},this.options.image);this.focuspoint=new b.media.robocrop.view.focuspoint.FocusPoint({controller:this.controller,focuspoint:this.options.focuspoint,enabled:this.options.enabled});this.listenTo(this.focuspoint,
"change:focuspoint",this.valueChanged)},setEnabled:function(a){return this.focuspoint.setEnabled(a)},render:function(){this.views.set([this.image,this.focuspoint])},getFocuspoint:function(){return this.focuspoint.getFocuspoint()},setFocuspoint:function(a){this.focuspoint&&this.focuspoint.setFocuspoint(a);return this},getImageWidth:function(){return this.image.$el.get(0).naturalWidth},getImageHeight:function(){return this.image.$el.get(0).naturalHeight},setSrc:function(a){this.image.$el.attr("src",
a);return this},valueChanged:function(){this.trigger("changed")}});b.media.robocrop.view.focuspoint.AskFocuspoint=e.extend({className:"ask-focuspoint media-frame",template:b.template("ask-focuspoint"),regions:["title","imagewrap","instructions","buttons"],events:{"click .reset":"reset","click .proceed":"proceed","click .cancel-upload":"cancelUpload"},initialize:function(){_.defaults(this.options,{uploader:!1,title:c.SetFocusPoint,modal:this.options?this.options.modal:!1,src:""});e.prototype.initialize.apply(this,
arguments);if(this.modal)this.modal.on("close",this.cancelUpload,this);this.createTitle();this.createContent();this.createInstructions();this.createButtons()},render:function(){this.$el.addClass("hide-menu").addClass("hide-router");e.prototype.render.apply(this,arguments)},createTitle:function(){this._title=new b.media.View({tagName:"h1"});this._title.$el.text(this.options.title);this.title.set([this._title])},createContent:function(){this._content=new b.media.robocrop.view.focuspoint.ImageFocusPointSelect({src:"",
focuspoint:{x:0,y:0},controller:this});this.imagewrap.set([this._content])},createInstructions:function(){this.instructions.set([new b.media.View({el:d('<div class="instructions">'+c.FocusPointInstructions+"</div>")[0],priority:-40})])},createButtons:function(){this.buttons.set([new b.media.view.Button({text:c.CancelUpload,className:"cancel-upload"}),new b.media.view.Button({text:c.reset,className:"reset"}),new b.media.view.Button({text:c.done,className:"button-primary proceed"})])},setSrc:function(a){this._content.setSrc(a)},
setFile:function(a){var b=this,c=new FileReader;c.onload=function(a){b._content.setSrc(a.target.result)};c.readAsDataURL(a)},setFocuspoint:function(a){this._content.setFocuspoint(a)},getFocuspoint:function(){return this._content.getFocuspoint()},getImageWidth:function(){return this._content.getImageWidth()},getImageHeight:function(){return this._content.getImageHeight()},reset:function(a){this.setFocuspoint({x:0,y:0})},proceed:function(a){this.trigger("proceed")},cancelUpload:function(a){this.trigger("cancel-upload");
this.close()}})})(wp,jQuery);
(function(b,f){var t=window.wp_robocrop.image_ratios,h=window.wp_robocrop.image_sizes,g=window.wp_robocrop.l10n,r='<button type="button" class="button robocrop-attachment">'+g.cropImage+"</button>",u='<button type="button" class="button-link robocrop-attachment">'+g.cropImage+"</button>",k=null,m=null,l=null,n=null,p={createStates:function(){this._parentCreateStates.apply(this,arguments);console.log("createStates",this.states);this.states.add(new b.media.robocrop.controller.SmartcropImage({model:this.model,
selection:this.options.selection}))}},q={bindHandlers:function(){this._parentBindHandlers.apply(this,arguments);this.on("content:create:robocrop-image",this.robocropImageMode,this);this.on("content:render:robocrop-image",this.robocropImageModeRender,this);console.log("handlers")},robocropImageMode:function(a){console.log("dohandlers");var e=new b.media.robocrop.controller.SmartcropImage({model:m,frame:this,content:this.content});e._toolbar=function(){};e._router=function(){};e._menu=function(){};
a.view=new b.media.robocrop.view.SmartcropImage({model:m,frame:this,controller:this.controller})},robocropImageModeRenderer:function(a){a.on("ready",a.loadEditor)}};_.extend(b.media.view.MediaFrame.EditAttachments.prototype,{_parentBindHandlers:b.media.view.MediaFrame.EditAttachments.prototype.bindHandlers},q);_.extend(b.media.view.MediaFrame.Post.prototype,{_parentBindHandlers:b.media.view.MediaFrame.Post.prototype.bindHandlers,_parentCreateStates:b.media.view.MediaFrame.Post.prototype.createStates},
q,p);_.extend(b.media.view.ImageDetails.prototype,{_parentPostRender:b.media.view.ImageDetails.prototype.postRender,postRender:function(){this._parentPostRender.apply(this,arguments);this.$el.find(".actions").append(r)},robocropAttachment:function(a){var b=this.controller.states.get("robocrop-image");console.log(this.controller);m=this.controller.image.attachment;k=null;n=this.controller;l=this.controller.state();b&&(a.preventDefault(),this.controller.setState("robocrop-image"))}});b.media.view.ImageDetails.prototype.events["click .robocrop-attachment"]=
"robocropAttachment";_.extend(b.media.view.MediaFrame.ImageDetails.prototype,{_parentBindHandlers:b.media.view.MediaFrame.ImageDetails.prototype.bindHandlers,_parentCreateStates:b.media.view.MediaFrame.ImageDetails.prototype.createStates},q,p);_.extend(b.media.view.Attachment.Details.prototype,{_parentRender:b.media.view.Attachment.Details.prototype.render,render:function(){this._parentRender.apply(this,arguments);this.$(".attachment-actions").append(r);f(u).insertAfter(this.$el.find("a.edit-attachment"))},
robocropAttachment:function(a){var b=this.controller.states.get("robocrop-image");m=this.model;n=this.controller;b?(k=null,l=this.controller.state(),a.preventDefault(),this.controller.setState("robocrop-image")):(k=this.controller.content.mode(),l=null,this.controller.content.mode("robocrop-image"))},_parentCreateStates:b.media.view.Attachment.Details.prototype.createStates},p);b.media.view.Attachment.Details.prototype.events["click .robocrop-attachment"]="robocropAttachment";b.media.robocrop.view.Img=
b.media.View.extend({className:"attachment-image",tagName:"img",id:"robocrop-image",initialize:function(){_.defaults(this.options,{src:""});console.log(this.options.src);this.$el.attr("src",this.options.src)},getSrc:function(a){return this.$el.attr("src")},setSrc:function(a){a&&this.$el.attr("src",a);return this}});b.media.robocrop.view.SmartcropRatioSelect=b.media.View.extend({className:"robocrop-select",template:b.template("robocrop-select"),events:{'click [name="robocrop-select-ratio"]':"selectRatio"},
initialize:function(){b.Backbone.View.prototype.initialize.apply(this,arguments);_.defaults({ratios:{},tools:{}},this.options);this.options.l10n=g},render:function(){b.Backbone.View.prototype.render.apply(this,arguments);var a=this;_.each(this.options.tools,function(e,c){a.views.add(new b.media.robocrop.view.SmartcropRatioSelectItem({ratiokey:c,sizenames:!1,ratio:c,title:e.title,enabled:!0}))});_.each(this.options.ratios,function(e,c){var d=[],g=_.template('<span class="sizename<%= cancrop ? "" : " disabled" %>"><%= name %> (<%= width %>\u00d7<%= height %>)</span>');
_.each(e.sizes,function(b,e){var c=f.extend(!0,{cancrop:a.model.get("width")>=h[b].width&&a.model.get("height")>=h[b].height},h[b]);c.crop&&d.push(g(c))});a.views.add(new b.media.robocrop.view.SmartcropRatioSelectItem({ratiokey:c,sizenames:d.join(""),ratio:c,title:c+" : 1",enabled:a.model.get("width")>=e.min_width&&a.model.get("height")>=e.min_height}))})},setSelected:function(a){this.$el.find('[name="robocrop-select-ratio"][value="'+a+'"]').prop("checked",!0);this.selectRatio()},getSelected:function(){return this.$el.find('[name="robocrop-select-ratio"]:checked').val()},
selectRatio:function(a){this.options.ratios[this.getSelected()]?this.trigger("select-ratio"):this.options.tools[this.getSelected()]&&this.trigger("select-tool")}});b.media.robocrop.view.SmartcropRatioSelectItem=b.media.View.extend({className:"robocrop-select-item",template:b.template("robocrop-select-item"),sizekey:"",sizenames:"",ratio:0,enabled:null,render:function(){b.Backbone.View.prototype.render.apply(this,arguments);this.$el.find('input[type="radio"]').prop("disabled",!this.options.enabled)}});
b.media.robocrop.view.SmartcropImage=b.media.View.extend({className:"image-robocrop",template:b.template("robocrop"),image_ratios:t,image_sizes:h,_croppers:null,events:{"click .robocrop-autocrop":"autocrop","click .robocrop-cancel":"cancel","click .robocrop-save":"save"},initialize:function(a){this._croppers={};this.sizeToSelect=a.frame&&a.frame.image?a.frame.image.attributes.size:!1;this.image=new b.media.robocrop.view.Img({src:this.model.get("url")});this.controller=a.controller;this.focuspointtool=
new b.media.robocrop.view.focuspoint.ImageFocusPointSelect({image:this.image,focuspoint:this.model.get("url")});this.listenTo(this.focuspointtool,"changed",this.updateFocusPoint);b.media.View.prototype.initialize.apply(this,arguments)},dispose:function(){var a=this.$areaSelect();a&&a.remove();b.media.view.EditImage.prototype.dispose.apply(this,arguments)},createSelect:function(){this.select=new b.media.robocrop.view.SmartcropRatioSelect({choices:choices})},render:function(){var a=this;b.media.View.prototype.render.apply(this,
arguments);this.views.set(".robocrop-image-box",this.focuspointtool);this.focuspointtool.setFocuspoint(this.model.get("focuspoint"));this.image.$el.imgAreaSelect({parent:this.image.$el.closest(".robocrop-image-box"),instance:!0,handles:!0,keys:!0,persistent:!0,enabled:!0,movable:!0,resizable:!0,imageHeight:this.model.get("height"),imageWidth:this.model.get("width"),onSelectEnd:function(e,c){var d=b.media.robocrop.pointToRectCoords(c);a._setCropSizes(d);a.$saveButton.prop("disabled",!1)}});this.selectRatio=
new b.media.robocrop.view.SmartcropRatioSelect({tools:{focuspoint:{title:g.SetFocusPoint,trigger:"focuspoint"}},ratios:this.image_ratios,model:this.model});this.selectRatio.on("select-ratio",this.onselectratio,this).on("select-tool",this.onselecttool,this);this.views.set(".select-ratio",this.selectRatio);this.$saveButton=this.$el.find(".robocrop-save");this.$cancelButton=this.$el.find(".robocrop-cancel");this.$autoButton=this.$el.find(".robocrop-autocrop");return this},ready:function(){var a,e;b.media.view.EditImage.prototype.ready.apply(this,
arguments);this.sizeToSelect&&(e=_.find(this.image_ratios,function(a){return-1<a.sizes.indexOf(this.sizeToSelect)},this))&&(a=e.name);a||(a="focuspoint");this.selectRatio.setSelected("focuspoint");return this},save:function(){var a={attachments:{}},b=this.model.get("id"),c=this.$saveButton.add(this.$cancelButton).add(this.$autoButton).prop("disabled",!0),d=this;a.attachments[b]={sizes:this.model.get("sizes"),focuspoint:this.model.get("focuspoint")};this.model.saveCompat(a,{}).done(function(a){var b=
new Date;_.each(d.model.attributes.sizes,function(a,e){"full"!==e&&f(document).add(f("iframe").contents()).find('img[src^="'+a.url+'"]').each(function(){f(this).attr("src",a.url+"?"+b.getTime())})},d);c.prop("disabled",!1)});return this},cancel:function(){k?n.content.mode(k):l&&n.setState(l);return this},onselecttool:function(){var a=this.selectRatio.getSelected();this.$areaSelect().cancelSelection();switch(a){case "focuspoint":this.focuspointtool.setEnabled(!0)}console.log(this.model.get("focuspoint"))},
onselectratio:function(){this.focuspointtool.setEnabled(!1);var a=this.selectRatio.getSelected(),b=this.model.get("sizes"),c,d,g=this,f,k=this.model.get("width"),l=this.model.get("height");this.current_ratio=this.image_ratios[a];f={aspectRatio:this.current_ratio.ratio+":1",minWidth:this.current_ratio.min_width,minHeight:this.current_ratio.min_height};_.each(this.current_ratio.sizes,function(a){!d&&b[a]&&b[a].cropdata&&(d=b[a].cropdata);h[a].width<=k&&h[a].height<=l&&(f.minWidth=Math.max(f.minWidth,
h[a].width),f.minHeight=Math.max(f.minHeight,h[a].height))});d?(c={},_.extend(c,d)):(a=Math.min(this.model.get("width")/this.current_ratio.ratio,this.model.get("height")),c={x:0,y:0,width:a*this.current_ratio.ratio,height:a},c.x=(this.model.get("width")-c.width)/2,c.y=(this.model.get("height")-c.height)/2);this.$areaSelect().setOptions(f);if(this.image.$el.get(0).complete)this.selectCrop(c);else this.image.$el.on("load",function(){g.selectCrop(c)});return this},autocrop:function(a){var e={width:this.model.get("width"),
height:this.model.get("height"),focuspoint:this.model.get("focuspoint")};a=b.media.robocrop.cropFromFocusPoint(e,this.current_ratio);a=b.media.robocrop.relToAbsCoords(a,e);this._setCropSizes(a);this.selectCrop(a);return this},selectCrop:function(a){this._image_scale_factor();a=b.media.robocrop.rectToPointCoords(a);var e=this.$areaSelect();e.setSelection(a.x1,a.y1,a.x2,a.y2,!1);e.setOptions({show:!0});e.update();return this},$areaSelect:function(){return f("#robocrop-image").data("imgAreaSelect")},
_image_scale_factor:function(){var a=this.image.$el.closest(".robocrop-image-box"),b=Math.min(this.model.get("width"),a.width()),a=Math.min(this.model.get("height"),a.height());return Math.min(b/this.model.get("width"),a/this.model.get("height"))},updateFocusPoint:function(){this.model.set("focuspoint",this.focuspointtool.getFocuspoint());this.$saveButton.prop("disabled",!1)},_setCropSizes:function(a){var b=this.model.get("sizes");_.each(this.current_ratio.sizes,function(c){!b[c]&&(b[c]={});b[c].cropdata=
a});this.model.set("sizes",b)},_getRelativeCoords:function(a){var b=this.model.get("width"),c=this.model.get("height"),d;for(d in a)if("number"===typeof a[d])switch(d){case "x":case "x1":case "x2":case "width":case "minX":case "maxX":a[d]/=b;break;default:a[d]/=c}},_getAbsoluteCoords:function(a){var b=this.model.get("width"),c=this.model.get("height"),d;for(d in a)if("number"===typeof a[d])switch(d){case "x":case "x1":case "x2":case "width":case "minX":case "maxX":a[d]*=b;break;default:a[d]*=c}}});
b.media.robocrop.controller.SmartcropImage=b.media.controller.State.extend({defaults:{id:"robocrop-image",title:g.robocropImage,menu:!1,toolbar:"robocrop-image",content:"robocrop-image",url:""},activate:function(){this.listenTo(this.frame,"toolbar:render:robocrop-image",this.toolbar)},deactivate:function(){this.stopListening(this.frame)}})})(wp,jQuery);
(function(h){var e=window.wp_robocrop.image_ratios,n=h.media.view.UploaderWindow.prototype.ready,p=!1,m={};window.wp_robocrop.options.ask_for_focuspoint&&(h.media.view.UploaderWindow.prototype.ready=function(){function h(q){var b;a&&a.close().dispose();l.length?(b=l.shift(),a=new wp.media.robocrop.view.focuspoint.AskFocuspoint({modal:!0}),a.on("proceed",function(){m[b.file.name]={focuspoint:a.getFocuspoint(),width:a.getImageWidth(),height:a.getImageHeight()};h(q)}).on("cancel-upload",function(){b.file.attachment.destroy()}),
a.setFocuspoint({x:0,y:0}),b.dataUrl?a.setSrc(b.dataUrl):a.setFile(b.blob),a.open()):q.start()}var l=[],a;if(p)return n.apply(this,arguments);p=!0;ret=n.apply(this,arguments);this.uploader.uploader.bind("FilesAdded",function(a,b){a.stop();a.refresh();for(var c=0;c<b.length;c++)if("image/png"==b[c].type||"image/jpeg"==b[c].type){var f=b[c],d={file:f,blob:f.getNative(),dataUrl:!1},g=void 0,e=void 0,k=void 0;d.blob||(d.blob=f.getSource());if(d.blob.getSource&&(g=d.blob.getSource(),"string"===typeof g)){d.dataUrl=
g;e=new Uint8Array(g.length);for(k=0;k<g.length;k++)e[k]=g.charCodeAt(k);d.blob=new Blob(e,{type:d.file.type})}(fileData=d)&&l.push(fileData)}l.length?h(a):a.start()});this.uploader.uploader.bind("BeforeUpload",function(a,b){var c,f;if(m[b.name]){imageinfo=m[b.name];f={};for(c in e)f[e[c].name]=wp.media.robocrop.cropFromFocusPoint(imageinfo,e[c]);a.settings.multipart_params.focuspoint=JSON.stringify(imageinfo.focuspoint);a.settings.multipart_params.cropdata=JSON.stringify(f)}});return ret})})(wp);
